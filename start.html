<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>åºƒè´AI Local Viewer</title>
</head>
<body>
  <h1>åºƒè´AI Local Viewer</h1>
  <p>åºƒè´AIã‹ã‚‰å‡ºåŠ›ã•ã‚ŒãŸãƒ•ã‚©ãƒ«ãƒ€ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚</p>
  <button id="selectDir">ãƒ•ã‚©ãƒ«ãƒ€ã‚’é¸æŠ</button>

  <script>
    const CACHE_NAME = 'next-export-dynamic-cache';

    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./sw.js').then(() => {
        console.log('âœ… Service Worker registered');
      });
    }

    document.getElementById('selectDir').addEventListener('click', async () => {
      if (!('showDirectoryPicker' in window)) {
        alert('File System Access API ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ãªã„ãƒ–ãƒ©ã‚¦ã‚¶ã§ã™ã€‚Chromeã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚');
        return;
      }

      const dirHandle = await window.showDirectoryPicker();
      const files = [];

      async function recursivelyCollectFiles(handle, path = '') {
        for await (const entry of handle.values()) {
          const entryPath = path ? `${path}/${entry.name}` : entry.name;
          if (entry.kind === 'file') {
            const file = await entry.getFile();
            files.push({ path: '/' + entryPath, file });
          } else if (entry.kind === 'directory') {
            await recursivelyCollectFiles(entry, entryPath);
          }
        }
      }

      await recursivelyCollectFiles(dirHandle);

      const registration = await navigator.serviceWorker.ready;
      const sw = registration.active;

      for (const { path, file } of files) {
        const arrayBuffer = await file.arrayBuffer();
        sw.postMessage({
          type: 'CACHE_FILE',
          path,
          buffer: arrayBuffer,
          mimeType: file.type || 'application/octet-stream',
        });
      }

      console.log('ğŸ“¦ ã‚­ãƒ£ãƒƒã‚·ãƒ¥å®Œäº†ï¼index.html ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã—ã¾ã™ã€‚');
      // ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã‚’è¡¨ç¤ºã™ã‚‹
      window.location.href = '/index.html';
    });
  </script>
</body>
</html>
